********************************************************************************
** Title: 			Map SVI/SDI to county opioid prescribing rates
** Stata version:	18 SE
** Date:			17 January 2024
********************************************************************************


/*******************************************************************************
Notes:
Data and code are available on GitHub

Makes sure to change directory to where you want to save the files.

*******************************************************************************/

************************
// LOAD DATA
************************

// CHANGE DIRECTORY
*** Make sure to change directory to path where you want to save files.


// IMPORT County Health Rankings
clear all
import delimited "https://raw.githubusercontent.com/mbounthavong/social-vulnerability-and-deprivation/main/Data/county_health_2020.csv"
/* SAVE FILE AS county_health_2020.dta */ 


// LOAD SVI with Opioid Prescribing Rates data
clear all
import deliminted "https://raw.githubusercontent.com/mbounthavong/social-vulnerability-and-deprivation/main/Data/svi_2020.csv"
/* SAVE FILE AS svi_2020.dta */ 


// MERGE the SVI + County-level estimates
merge 1:1 fips_conv using county_health_2020
keep if _merge == 3
drop _merge

// SAVE data for merge AS svi_data1.dta


// LOAD Social Deprivation Index
clear all
import delimited "https://raw.githubusercontent.com/mbounthavong/social-vulnerability-and-deprivation/main/Data/sdi_2019.csv"
/* SAVE FILE AS sdi_2019.dta */ 


// RENAME county_fips
rename county_fips fips_conv


// MERGE SDI + SVI + County-level estimates
merge 1:1 fips_conv using svi_data1
drop _merge

// SAVE SDI + SVI merge data AS sdi_svi_data1.dta (This is the FINAL dataset for these analyses)




************************
// CLEAN DATA
************************

// RENAME primary care physician and mental health providers prevalance
rename primarycarephysicians pcp_prev
rename mentalhealthproviders mh_prev

// RENAME rpl_themes to svi_value
rename rpl_themes svi_value
sum svi_value

// RENAME Life lost rate - Years of potential life lost before age 75 per 100,000 population (age-adjusted).
rename yearsofpotentiallifelostrate life_lost

// RENAME Percent with poor health - Percentage of adults reporting fair or poor health (age-adjusted).
rename fairorpoorhealth poor_health

// RENAME Average number of unhealthy days
rename averagenumberofphysicallyunhealt avg_num_physical_unhealthy
rename averagenumberofmentallyunhealthy avg_num_mental_unhealthy

// LABEL STATES
label define state_lbl ///
		1  "Alabama" ///
		2  "Alaska" ///
		4  "Arizona" ///
		5  "Arkansas" ///
		6  "California" ///
		8  "Colorado" ///
		9  "Connecticut" ///
		10  "Delaware" ///
		11  "District of Columbia" ///
		12  "Florida" ///
		13  "Georgia" ///
		15  "Hawaii" ///
		16  "Idaho" ///
		17  "Illinois" ///
		18  "Indiana" ///
		19  "Iowa" ///
		20  "Kansas" ///
		21  "Kentucky" ///
		22  "Louisiana" ///
		23  "Maine" ///
		24  "Maryland" ///
		25  "Massachusetts" ///
		26  "Michigan" ///
		27  "Minnesota" ///
		28  "Mississippi" ///
		29  "Missouri" ///
		30  "Montana" ///
		31  "Nebraska" ///
		32  "Nevada" ///
		33  "New Hampshire" ///
		34  "New Jersey" ///
		35  "New Mexico" ///
		36  "New York" ///
		37  "North Carolina" ///
		38  "North Dakota" ///
		39  "Ohio" ///
		40  "Oklahoma" ///
		41  "Oregon" ///
		42  "Pennsylvania" ///
		44  "Rhode Island" ///
		45  "South Carolina" ///
		46  "South Dakota" ///
		47  "Tennessee" ///
		48  "Texas" ///
		49  "Utah" ///
		50  "Vermont" ///
		51  "Virginia" ///
		53  "Washington" ///
		54  "West Virginia" ///
		55  "Wisconsin" ///
		56  "Wyoming" 
label value st state_lbl
tab st, m



// GEN OUD prevalanece numeric
destring oud_prev, gen(oud_prev_num) force
drop if oud_prev_num == .

// GEN opioid dispensing rate numeric
destring opioid_disp, gen(opioid_rate_num) force
drop if opioid_rate_num == .

// INSPECT DATA
sum oud_prev_num
sum svi_value
sum opioid_rate_num


// CREATE SVI - QUNTILE
xtile svi_quintile = svi_value, nq(5)
tab svi_quintile, m

// CREATE SVI - QUARTILE
xtile svi_quartile = svi_value, nq(4)
tab svi_quartile, m


// CREATE SDI - QUNTILE
xtile sdi_quintile = sdi_score, nq(5)
tab sdi_quintile, m

// CREATE SDI - QUARTILE
xtile sdi_quartile = sdi_score, nq(4)
tab sdi_quartile, m




************************
// KEEP VARIABLES
************************
keep opioid_rate_num svi_value svi_quintile sdi_score sdi_quintile pcp_prev mh_prev life_lost poor_health avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking percent_rural st

************************
// DESCRIPTIVE ANALYSES
************************


************************
** SVI - Descriptives
************************
// Groupings
tab svi_quintile, m 

tabstat svi_value, by(svi_quintile) stat(n mean min max)

oneway svi_value svi_quintile, scheffe tabulate
oneway pcp_prev svi_quintile, scheffe tabulate
oneway mh_prev svi_quintile, scheffe tabulate
oneway life_lost svi_quintile, scheffe tabulate
oneway poor_health svi_quintile, scheffe tabulate
oneway avg_num_physical_unhealthy svi_quintile, scheffe tabulate
oneway avg_num_mental_unhealthy svi_quintile, scheffe tabulate
oneway lowbirthweight svi_quintile, scheffe tabulate
oneway smokers svi_quintile, scheffe tabulate
oneway adultswithobesity svi_quintile, scheffe tabulate
oneway physicallyinactive svi_quintile, scheffe tabulate
oneway excessivedrinking svi_quintile, scheffe tabulate
oneway percent_rural svi_quintile, scheffe tabulate

        

// Evaluate Opioid prescribing rate by SVI quintile - One-Way ANOVA
oneway opioid_rate_num svi_quintile, scheffe tabulate /* One-way analysis of variance */ 
mean opioid_rate_num, over(svi_quintile) /* Generate mean and 95% CI */


************************
** SDI - Descriptives
************************
// Groupings
tab sdi_quintile, m 

tabstat sdi_score, by(sdi_quintile) stat(n mean min max)

oneway sdi_score sdi_quintile, scheffe tabulate
oneway pcp_prev sdi_quintile, scheffe tabulate
oneway mh_prev sdi_quintile, scheffe tabulate
oneway life_lost sdi_quintile, scheffe tabulate
oneway poor_health sdi_quintile, scheffe tabulate
oneway avg_num_physical_unhealthy sdi_quintile, scheffe tabulate
oneway avg_num_mental_unhealthy sdi_quintile, scheffe tabulate
oneway lowbirthweight sdi_quintile, scheffe tabulate
oneway smokers sdi_quintile, scheffe tabulate
oneway adultswithobesity sdi_quintile, scheffe tabulate
oneway physicallyinactive sdi_quintile, scheffe tabulate
oneway excessivedrinking sdi_quintile, scheffe tabulate
oneway percent_rural sdi_quintile, scheffe tabulate

        
// Evaluate Opioid prescribing rate by SDI quintile - One-Way ANOVA
oneway opioid_rate_num sdi_quintile, scheffe tabulate /* One-way analysis of variance */ 
mean opioid_rate_num, over(sdi_quintile) /* Generate mean and 95% CI */



**************************************************************************************************************
// SVI - QUINTILE: REGRESSION MODEL - Eval the association between opioid dispensing and svi
**************************************************************************************************************

// Negative binomial regression model - CRUDE
glm opioid_rate_num i.svi_quintile, family(nbin) link(log) vce(robust) eform

// Negative binomial regression model - ADJUSTED
glm opioid_rate_num i.svi_quintile i.st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking, family(nbin) link(log) vce(robust) eform
estimate store svi_nbreg3  /* Store results */
margins, dydx(svi_quintile) /* AME with reference */
estat ic /* Check model fit */

// PLOT Forest Plot
coefplot svi_nbreg3, bylabel("Full model") drop(_cons) byopts(compact rows(1)) eform ///
		 headings(2.svi_quintile = "{bf:Quintiles (REF = Quintile 1)}" ///
		 		  pcp_prev = "{bf:County-level factors}" ///
		          2.st = "{bf:States (REF = Alabama)}" , labsize(tiny) labcolor(cranberry)) ///
		 xline(1, lcolor(cranberry) lpattern(shortdash)) scale(1) ysize(10) xsize(8) ylab(, labs(tiny)) xlab(0(1)3, nogrid labsize(small)) ///
		 graphregion(color(white)) ///
		 bgcolor(white) ///
		 grid(none) ///
		 msymbol(D) ///
		 msize(vsmall) ///
		 mcolor(navy) ///
		 mfcolor(magenta*.3) ///
		 ciopts(lcolor(navy)) ///
		 xtitle("IRR (95% CI)", size(small))
graph save svi_nbin1.gph, replace



*******************************
// MISSING DATA ANALYSIS - SVI
*******************************

*** Missing data descriptive
mdesc svi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking

*** MI SET 
mi set mlong

*** Missing data tabulate
mi misstable summarize svi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking

*** Missing data pattersn
mi misstable patterns svi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking

*** Check for correlation
pwcorr svi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking, obs

*** Register the variables for imputation
mi register imputed svi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking

*** Imputation model
mi impute mvn svi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking, add(10) rseed(11245)

*** Analysis
**** Crude model
mi estimate, eform: glm opioid_rate_num i.svi_quintile, family(nbin) link(log) vce(robust)
estimate store mi1

**** Full model
mi estimate, eform: glm opioid_rate_num i.svi_quintile i.st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking, family(poisson) link(log) vce(robust) eform
estimate store mi2


// PLOT Forest Plot - Mulitple imputed results
coefplot mi1, bylabel("Crude") subtitle(, size(vsmall)) drop(_cons) eform || ///
		 mi2, bylabel("Full model") drop(_cons) byopts(compact rows(1)) eform ///
		 headings(2.svi_quintile = "{bf:Quintiles (REF = Quintile 1)}" ///
		 		  pcp_prev = "{bf:County-level factors}" ///
		          2.st = "{bf:States (REF = Alabama)}" , labsize(tiny) labcolor(cranberry)) ///
		 xline(1, lcolor(cranberry) lpattern(shortdash)) scale(0.3) ysize(90) xsize(90) ylab(, labs(tiny)) xlab(, nogrid labsize(small)) ///
		 graphregion(color(white)) ///
		 bgcolor(white) ///
		 grid(none) ///
		 msymbol(D) ///
		 msize(vsmall) ///
		 mcolor(navy) ///
		 mfcolor(magenta*.3) ///
		 ciopts(lcolor(navy)) ///
		 xtitle("Incidence rate ratio (IRR)", size(small))


	 
		 
		 

**************************************************************************************************************
// SDI - QUINTILE: LINEAR REGRESSION MODEL - Eval the association between opioid dispensing and SDI
**************************************************************************************************************

// Negative binomial regression model - CRUDE
glm opioid_rate_num i.sdi_quintile, family(nbin) link(log) vce(robust) eform

// Negative binomial regression model - ADJUSTED
glm opioid_rate_num i.sdi_quintile i.st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking, family(nbin) link(log) vce(robust) eform
estimate store sdi_nbreg3  /* Store results */
margins, dydx(sdi_quintile) /* AME with reference */
estat ic /* Check model fit */


// PLOT Forest Plot
coefplot sdi_nbreg3, bylabel("Full model") drop(_cons) byopts(compact rows(1)) eform ///
		 headings(2.sdi_quintile = "{bf:Quintiles (REF = Quintile 1)}" ///
		 		  pcp_prev = "{bf:County-level factors}" ///
		          2.st = "{bf:States (REF = Alabama)}" , labsize(tiny) labcolor(cranberry)) ///
		 xline(1, lcolor(cranberry) lpattern(shortdash)) scale(1) ysize(10) xsize(8) ylab(, labs(tiny)) xlab(0(1)3, nogrid labsize(small)) ///
		 graphregion(color(white)) ///
		 bgcolor(white) ///
		 grid(none) ///
		 msymbol(D) ///
		 msize(vsmall) ///
		 mcolor(navy) ///
		 mfcolor(magenta*.3) ///
		 ciopts(lcolor(navy)) ///
		 xtitle("IRR (95% CI)", size(small))
graph save sdi_nbin1.gph, replace



// COMBINE GRAPHS
graph combine "svi_nbin1.gph" "sdi_nbin1.gph", col(2) ///
		xsize(7) ///
		ysize(6) ///
		iscale(*1) ///
		graphregion(color(white))
graph export svi_sdi_forst2.png, replace






*******************************
// MISSING DATA ANALYSIS - SDI
*******************************

*** Missing data descriptive
mdesc sdi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking

*** MI SET 
mi set mlong

*** Missing data tabulate
mi misstable summarize sdi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking

*** Missing data pattersn
mi misstable patterns sdi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking

*** Check for correlation
pwcorr sdi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking, obs

*** Register the variables for imputation
mi register imputed sdi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking

*** Imputation model
mi impute mvn sdi_quintile st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking, add(10) rseed(11245)

*** Analysis
**** Crude model
mi estimate, eform: glm opioid_rate_num i.sdi_quintile, family(nbin) link(log) vce(robust)
estimate store mi1

**** Full model
mi estimate, eform: glm opioid_rate_num i.sdi_quintile i.st pcp_prev mh_prev life_lost poor_health percent_rural avg_num_physical_unhealthy avg_num_mental_unhealthy lowbirthweight smokers adultswithobesity physicallyinactive excessivedrinking, family(poisson) link(log) vce(robust) eform
estimate store mi2


// PLOT Forest Plot - Mulitple imputed results
coefplot mi1, bylabel("Crude") subtitle(, size(vsmall)) drop(_cons) eform || ///
		 mi2, bylabel("Full model") drop(_cons) byopts(compact rows(1)) eform ///
		 headings(2.sdi_quintile = "{bf:Quintiles (REF = Quintile 1)}" ///
		 		  pcp_prev = "{bf:County-level factors}" ///
		          2.st = "{bf:States (REF = Alabama)}" , labsize(tiny) labcolor(cranberry)) ///
		 xline(1, lcolor(cranberry) lpattern(shortdash)) scale(0.3) ysize(90) xsize(90) ylab(, labs(tiny)) xlab(, nogrid labsize(small)) ///
		 graphregion(color(white)) ///
		 bgcolor(white) ///
		 grid(none) ///
		 msymbol(D) ///
		 msize(vsmall) ///
		 mcolor(navy) ///
		 mfcolor(magenta*.3) ///
		 ciopts(lcolor(navy)) ///
		 xtitle("Incidence rate ratio (IRR)", size(small))


